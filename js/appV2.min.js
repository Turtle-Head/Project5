var map;var loading=ko.observable(false);var pDmodel=[{name:"Bohemian Cafe & Catering Company",address:"524 Bernard Ave",id:"ChIJNR-8ZKj0fVMRUTly1t01rtc"},{name:"Mad Mango Cafe",address:"551 Bernard Ave",id:"ChIJ0RjRaaj0fVMRJtulviLYwuo"},{name:"The Bean Scene Coffee House",address:"274 Bernard Ave",id:"ChIJB2yMA6b0fVMRIk_JoBlIjxg"},{name:"Mosaic Books",address:"411 Bernard Ave",id:"ChIJ_1Wqnqj0fVMRoYgRc9oy_Zg"},{name:"The Royal Anne Hotel",address:"348 Bernard Ave",id:"ChIJK-KSIKb0fVMRqeg_8E-UyK0"}];var nonce_generate=function(){var c=(Math.floor(Math.random()*32))+(Math.floor(Math.random()*32));var d="";var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(var b=0;b<c;b++){d+=a.charAt(Math.floor(Math.random()*a.length))}return d};var set_hidden=function(){self.currentYelp().visibility(false);infoWindow.close()};var resetFilter=function(){self.user_input("")};var set_visible=function(){self.currentYelp().visibility(true)};var PlaceData=function(d){var a=this;var l=function(m){for(var i in m){m=m.replace(" ","+");m=m.replace(", ","+");m=m.replace(",","+");m=m.replace("++","+")}return(m)};this.id=d.id;this.vis=ko.observable(true);this.name=ko.observable(d.name);this.address=ko.observable(d.address);this.city=ko.observable("Kelowna");this.province=ko.observable("British Columbia");this.location=l(d.name+" "+d.address)+"+Kelowna+British+Columbia";this.svLoc=l(d.address)+"+Kelowna+British+Columbia";this.yelp=ko.observable(0);this.locImg=ko.observable("https://maps.googleapis.com/maps/api/streetview?size=350x150&location="+this.svLoc+' width="350px"');this.markerId=ko.observable(0);this.gPlace=ko.observable(0);this.lat=ko.observable(0);this.lng=ko.observable(0);this.visibility=ko.observable(false);this.rating=ko.computed(function(){return((this.gPlace().rating+this.yelp().rating)/2)},this);this.types=ko.computed(function(){var o=[];for(var m in this.gPlace().types){o.push(this.gPlace().types[m])}for(var q in this.yelp().categories){for(var p in this.yelp().categories[q]){o.push(this.yelp().categories[q][p])}}return o},this);var k=ko.observableArray([]);if(typeof(this.gPlace().photo)!=="undefined"){for(var e in this.gPlace().photos()){k().push(this.gPlace().photos[e].getUrl({maxWidth:350,maxHeight:100}))}}var g;for(var f=0;f<Math.floor(Math.random()*Math.floor(Math.random()*20));f++){g=nonce_generate()}var h=YELP_BASE_URL;var j={oauth_consumer_key:YELP_KEY,oauth_token:YELP_TOKEN,oauth_nonce:nonce_generate(),oauth_timestamp:Math.floor(Date.now()/1000),oauth_signature_method:"HMAC-SHA1",oauth_version:"1.0",callback:"cb",limit:1,term:d.name+" Kelowna",location:d.address,id:d.name+" Kelowna",city:"Kelowna",province:"British Columbia",cc:"CA"};var b=oauthSignature.generate("GET",h,j,YELP_KEY_SECRET,YELP_TOKEN_SECRET);j.oauth_signature=b;var c={url:h,data:j,cache:true,dataType:"jsonp",success:function(i){a.yelp(i.businesses[0])},error:function(){alert("Failed to import Yelp data")}};$.ajax(c);this.contentString=ko.observable("");this.setYelp=function(i){self.currentYelp(i);set_visible();google.maps.event.trigger(this.markerId(),"click")}};var ViewModel=function(){var b=this;this.places=ko.observableArray([]);pDmodel.forEach(function(g){b.places.push(new PlaceData(g))});this.currentYelp=ko.observable(this.places()[0]);console.log("Places Model:");console.log(b.places());var d;var a=function(h,i){var g={lat:h.lat(),lng:h.lng()};if(h.gPlace().website){i+='<div width="350px" class="flex"><div class="flex2"><a href="'+h.gPlace().website+'" class="inf-Win">'+h.name()+'</a><div class="inf-Win">'+h.address()+"</div>"}else{i+='<div width="350px" class="flex"><div class="flex2"><div class="inf-Win">'+h.name()+'</div><div class="inf-Win">'+h.address()+"</div>"}if((typeof h.gPlace().photos)!=="undefined"){i+='<img src="'+h.gPlace().photos[0].getUrl({maxWidth:350,maxHeight:100})+'" height="100px" class="images">'}else{i+='<img src="'+h.locImg()+'" height="100px" class="images">'}if(h.gPlace().reviews.length>0){i+='<div class="rev_com">'+h.gPlace().reviews[0].text+"</div></div>"}else{i+="</div></div>"}d.setContent(i);d.setPosition(g);d.open(map);set_visible()};this.user_input=ko.observable("");var f=function(){if(b.places()[0]){loading(true)}};var c=function(h,g){if(h.indexOf(g)>=0){return true}else{return false}};var e=function(){var i={disableDefaultUI:false,mapTypeId:google.maps.MapTypeId.HYBRID,scrollwheel:false,scaleControl:false,zoomControl:false,styles:[{featureType:"water",elementType:"geometry",stylers:[{color:"#193341"}]},{featureType:"landscape",elementType:"geometry",stylers:[{color:"#2c5a71"}]},{featureType:"road",elementType:"geometry",stylers:[{color:"#29768a"},{lightness:-37}]},{featureType:"poi",elementType:"geometry",stylers:[{color:"#406d80"}]},{featureType:"transit",elementType:"geometry",stylers:[{color:"#406d80"}]},{elementType:"labels.text.stroke",stylers:[{visibility:"on"},{color:"#3e606f"},{weight:2},{gamma:0.84}]},{elementType:"labels.text.fill",stylers:[{color:"#ffffff"}]},{featureType:"administrative",elementType:"geometry",stylers:[{weight:0.6},{color:"#1a3541"}]},{elementType:"labels.icon",stylers:[{visibility:"off"}]},{featureType:"poi.park",elementType:"geometry",stylers:[{color:"#2c5a71"}]}]};var h=function(s,q){var v=s.geometry.location.lat();var n=s.geometry.location.lng();var o=s.formatted_address;var m=window.mapBounds;var u="img/marker3.png";var t=new google.maps.Marker({map:map,position:s.geometry.location,animation:google.maps.Animation.DROP,title:o,icon:u});b.places()[q].markerId(t);var r="";d=new google.maps.InfoWindow();google.maps.event.addListener(t,"click",function(p){a(b.places()[q],r);if(t.getAnimation()!==null){t.setAnimation(null)}else{t.setAnimation(google.maps.Animation.BOUNCE)}b.currentYelp(b.places()[q]);set_visible()});google.maps.event.addListener(d,"closeclick",function(){set_hidden()});m.extend(new google.maps.LatLng(v,n));map.fitBounds(m);map.setCenter(m.getCenter())};var l=function(o,m){if(m==google.maps.places.PlacesServiceStatus.OK){for(var n in b.places()){if(o.name.toLowerCase()==b.places()[n].name().toLowerCase()){b.places()[n].gPlace(o);h(o,n);b.places()[n].lat(o.geometry.location.lat());b.places()[n].lng(o.geometry.location.lng())}}}else{alert("Failed to import Google Places data");console.log(m)}};map=new google.maps.Map(document.querySelector("#map"),i);window.mapBounds=new google.maps.LatLngBounds();var g=new google.maps.places.PlacesService(map);for(var k in b.places()){var j={placeId:b.places()[k].id};g.getDetails(j,l)}};e();this.filterData=ko.computed(function(){if((b.user_input().length===0)&&(b.places().length>0)){for(var g in b.places()){b.places()[g].vis(true);if(b.places()[g].markerId()){b.places()[g].markerId().setMap(map)}}}else{if(b.places().length>0){for(var i in b.places()){b.places()[i].vis(false);for(var h in b.places()[i].types()){if(c((b.places()[i].types()[h]).toLowerCase(),(b.user_input()).toLowerCase())&&!b.places()[i].vis()){b.places()[i].vis(true)}}if(c((b.places()[i].name()).toLowerCase(),(b.user_input()).toLowerCase())&&!b.places()[i].vis()){b.places()[i].vis(true)}if(c((b.places()[i].address()).toLowerCase(),(b.user_input()).toLowerCase())&&!b.places()[i].vis()){b.places()[i].vis(true)}if(b.places()[i].vis()&&b.places()[i].markerId()){b.places()[i].markerId().setMap(map)}else{if(!b.places()[i].vis()&&b.places()[i].markerId()){b.places()[i].markerId().setMap(null)}}}}}return b.user_input()},this);f()};