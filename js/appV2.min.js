var map;var loading=ko.observable(false);var pDmodel=[{name:"Bohemian Cafe & Catering Company",address:"524 Bernard Ave",id:"ChIJNR-8ZKj0fVMRUTly1t01rtc"},{name:"Mad Mango Cafe",address:"551 Bernard Ave",id:"ChIJ0RjRaaj0fVMRJtulviLYwuo"},{name:"The Bean Scene Coffee House",address:"274 Bernard Ave",id:"ChIJB2yMA6b0fVMRIk_JoBlIjxg"},{name:"Mosaic Books",address:"411 Bernard Ave",id:"ChIJ_1Wqnqj0fVMRoYgRc9oy_Zg"},{name:"The Royal Anne Hotel",address:"348 Bernard Ave",id:"ChIJK-KSIKb0fVMRqeg_8E-UyK0"}];var nonce_generate=function(){var c=(Math.floor(Math.random()*32))+(Math.floor(Math.random()*32));var d="";var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(var b=0;b<c;b++){d+=a.charAt(Math.floor(Math.random()*a.length))}return d};var PlaceData=function(e){var a=this;var o=function(p){for(var i in p){p=p.replace(" ","+");p=p.replace(", ","+");p=p.replace(",","+");p=p.replace("++","+")}return(p)};a.id=e.id;a.vis=ko.observable(true);a.name=ko.observable(e.name);a.address=ko.observable(e.address);a.city=ko.observable("Kelowna");a.province=ko.observable("British Columbia");a.location=o(e.name+" "+e.address)+"+Kelowna+British+Columbia";a.svLoc=o(e.address)+"+Kelowna+British+Columbia";a.yelp=ko.observable(0);a.locImg=ko.observable("https://maps.googleapis.com/maps/api/streetview?size=350x150&location="+this.svLoc+' width="350px"');a.markerId=ko.observable(0);a.gPlace=ko.observable(0);a.lat=ko.observable(0);a.lng=ko.observable(0);a.visibility=ko.observable(false);a.rating=ko.computed(function(){return((a.gPlace().rating+a.yelp().rating)/2)},this);a.gReview=ko.computed(function(){return(a.gPlace().reviews)},this);a.types=ko.computed(function(){var q=[];for(var p in a.gPlace().types){q.push(a.gPlace().types[p])}for(var s in a.yelp().categories){for(var r in a.yelp().categories[s]){q.push(a.yelp().categories[s][r])}}return q},this);var d=function(){a.visibility(!a.visibility())};var n=ko.observableArray([]);if(typeof(a.gPlace().photo)!=="undefined"){for(var f in a.gPlace().photos()){n().push(a.gPlace().photos[f].getUrl({maxWidth:350,maxHeight:100}))}}var j;for(var h=0;h<Math.floor(Math.random()*Math.floor(Math.random()*20));h++){j=nonce_generate()}var l=YELP_BASE_URL;var m={oauth_consumer_key:YELP_KEY,oauth_token:YELP_TOKEN,oauth_nonce:nonce_generate(),oauth_timestamp:Math.floor(Date.now()/1000),oauth_signature_method:"HMAC-SHA1",oauth_version:"1.0",callback:"cb",limit:1,term:e.name+" Kelowna",location:e.address,id:e.name+" Kelowna",city:"Kelowna",province:"British Columbia",cc:"CA"};var b=oauthSignature.generate("GET",l,m,YELP_KEY_SECRET,YELP_TOKEN_SECRET);m.oauth_signature=b;var c={url:l,data:m,cache:true,dataType:"jsonp",success:function(i){a.yelp(i.businesses[0]);clearTimeout(k)},error:function(){alert("Failed to import Yelp Data. Status: "+textStatus+" Error: "+errorThrown)}};var k=setTimeout(function(){alert("Yelp appears to be down, please try again later")},8000);$.ajax(c);a.contentString=ko.observable("");var g=function(p){for(var i in places()){places()[i].visibility(false)}a.visibility(true);google.maps.event.trigger(a.markerId(),"click")}};var ViewModel=function(){var c=this;c.places=ko.observableArray([]);c.currentYelp=ko.observable();pDmodel.forEach(function(i){c.places.push(new PlaceData(i))});c.currentYelp(this.places()[0]);c.panelView=ko.computed(function(){if(typeof(places)=="function"){for(var i=0;i<places().length;i++){if(places()[i].visibility()){c.currentYelp(places()[i]);c.currentYelp().visibility(true)}}}return c.currentYelp()},this);var e;var b=function(j,l,k){var i={lat:j.lat(),lng:j.lng()};if(j.gPlace().website){l+='<div width="350px" class="flex"><div class="flex2"><a href="'+j.gPlace().website+'" class="inf-Win">'+j.name()+'</a><div class="inf-Win">'+j.address()+"</div>"}else{l+='<div width="350px" class="flex"><div class="flex2"><div class="inf-Win">'+j.name()+'</div><div class="inf-Win">'+j.address()+"</div>"}if((typeof j.gPlace().photos)!=="undefined"){for(var m in j.gPlace().photos){l+='<img src="'+j.gPlace().photos[m].getUrl({maxWidth:350,maxHeight:100})+'" height="100px" class="images">'}}else{l+='<img src="'+j.locImg()+'" height="100px" class="images">'}if((typeof j.yelp().snippet_text)!=="undefined"){l+='<div class="rev_com">'+j.yelp().snippet_text+"</div></div>"}else{l+="</div></div>"}e.setContent(l);e.setPosition(i);e.open(map);c.places()[k].visibility(true)};c.user_input=ko.observable("");c.filter_address=ko.observable(true);c.filter_types=ko.observable(true);c.filter_names=ko.observable(true);var g=function(){if(c.places()[0]){loading(true)}};c.resetFilter=function(){c.user_input("")};var d=function(j,i){if(j.indexOf(i)>=0){return true}else{return false}};var a=function(q,l,m){var s=q.geometry.location.lat();var j=q.geometry.location.lng();var k=m;var i=window.mapBounds;var r="img/marker3.png";var o=new google.maps.Marker({map:map,position:q.geometry.location,animation:google.maps.Animation.DROP,title:k,icon:r});c.places()[l].markerId(o);var n="";e=new google.maps.InfoWindow({maxWidth:250});google.maps.event.addListener(o,"click",function(t){b(c.places()[l],n,l);for(var p in c.places()){if(c.places()[p].markerId().getAnimation()!==null){c.places()[p].markerId().setAnimation(null)}}c.places()[l].markerId().setAnimation(google.maps.Animation.BOUNCE);c.currentYelp(c.places()[l]);c.places()[l].visibility(true)});google.maps.event.addListener(e,"closeclick",function(){c.places().forEach(function(p){p.visibility(false)})});i.extend(new google.maps.LatLng(s,j));map.fitBounds(i);map.setCenter(i.getCenter())};var h=function(l,j){if(j==google.maps.places.PlacesServiceStatus.OK){for(var k in c.places()){if(l.name.toLowerCase()==c.places()[k].name().toLowerCase()){c.places()[k].gPlace(l);a(l,k,l.name);c.places()[k].lat(l.geometry.location.lat());c.places()[k].lng(l.geometry.location.lng())}}}else{alert("Failed to import Google Places data")}};var f=function(){var j={disableDefaultUI:false,mapTypeId:google.maps.MapTypeId.HYBRID,scrollwheel:false,scaleControl:false,zoomControl:false,styles:[{featureType:"water",elementType:"geometry",stylers:[{color:"#193341"}]},{featureType:"landscape",elementType:"geometry",stylers:[{color:"#2c5a71"}]},{featureType:"road",elementType:"geometry",stylers:[{color:"#29768a"},{lightness:-37}]},{featureType:"poi",elementType:"geometry",stylers:[{color:"#406d80"}]},{featureType:"transit",elementType:"geometry",stylers:[{color:"#406d80"}]},{elementType:"labels.text.stroke",stylers:[{visibility:"on"},{color:"#3e606f"},{weight:2},{gamma:0.84}]},{elementType:"labels.text.fill",stylers:[{color:"#ffffff"}]},{featureType:"administrative",elementType:"geometry",stylers:[{weight:0.6},{color:"#1a3541"}]},{elementType:"labels.icon",stylers:[{visibility:"off"}]},{featureType:"poi.park",elementType:"geometry",stylers:[{color:"#2c5a71"}]}]};map=new google.maps.Map(document.querySelector("#map"),j);window.mapBounds=new google.maps.LatLngBounds();var i=new google.maps.places.PlacesService(map);for(var l in c.places()){var k={placeId:c.places()[l].id};i.getDetails(k,h)}};f();c.filterData=ko.computed(function(){if((c.user_input().length===0)&&(c.places().length>0)){for(var i in c.places()){c.places()[i].vis(true);if(c.places()[i].markerId()){c.places()[i].markerId().setMap(map)}}}else{if(c.places().length>0){for(var k in c.places()){c.places()[k].vis(false);if(c.filter_types()){for(var j in c.places()[k].types()){if(d((c.places()[k].types()[j]).toLowerCase(),(c.user_input()).toLowerCase())&&!c.places()[k].vis()){c.places()[k].vis(true)}}}if(c.filter_names()&&(d((c.places()[k].name()).toLowerCase(),(c.user_input()).toLowerCase())&&!c.places()[k].vis())){c.places()[k].vis(true)}if(c.filter_address()&&(d((c.places()[k].address()).toLowerCase(),(c.user_input()).toLowerCase())&&!c.places()[k].vis())){c.places()[k].vis(true)}if(c.places()[k].vis()&&c.places()[k].markerId()){c.places()[k].markerId().setMap(map)}else{if(!c.places()[k].vis()&&c.places()[k].markerId()){c.places()[k].markerId().setMap(null)}}}}}return c.user_input()},this);g()};