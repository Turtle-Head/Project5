var map;var pDmodel=[{name:"Bohemian Cafe & Catering Company",address:"524 Bernard Ave",id:"tgfp"},{name:"Mad Mango Cafe",address:"551 Bernard Ave",id:"mmc"},{name:"Bean Scene Downtown",address:"274 Bernard Ave",id:"bsd"},{name:"Mosaic Books",address:"411 Bernard Ave",id:"mosaic"},{name:"The Royal Anne Hotel",address:"348 Bernard Ave",id:"lcp"}];var searchString=function(b){for(var a in b){b=b.replace(" ","+");b=b.replace(", ","+");b=b.replace(",","+");b=b.replace("++","+")}return(b)};var PlaceData=function(h){var b=this;this.id=h.id;this.name=ko.observable(h.name);this.address=ko.observable(h.address);this.city=ko.observable("Kelowna");this.province=ko.observable("British Columbia");this.location=searchString(h.address)+"+Kelowna+British+Columbia";this.yelp=ko.observable(0);this.locImg=ko.observable("https://maps.googleapis.com/maps/api/streetview?size=350x150&location="+this.location+' width="350px"');this.contentString=ko.observable("<div>"+this.name()+'</div><div class="address" id="'+this.id+'">'+this.address()+"</div>");this.markerId=ko.observable(0);this.gPlace=ko.observable(0);this.gData=ko.observable(0);var a;for(var e=0;e<Math.floor(Math.random()*Math.floor(Math.random()*20));e++){a=nonce_generate()}var g=YELP_BASE_URL;var d={oauth_consumer_key:YELP_KEY,oauth_token:YELP_TOKEN,oauth_nonce:nonce_generate(),oauth_timestamp:Math.floor(Date.now()/1000),oauth_signature_method:"HMAC-SHA1",oauth_version:"1.0",callback:"cb",limit:1,term:h.name+" Kelowna",location:h.address,id:h.name+" Kelowna",city:"Kelowna",province:"British Columbia",cc:"CA"};var f=oauthSignature.generate("GET",g,d,YELP_KEY_SECRET,YELP_TOKEN_SECRET);d.oauth_signature=f;var c={url:g,data:d,cache:true,dataType:"jsonp",success:function(i){b.yelp(i.businesses[0])},error:function(){console.log("Failed to import Data")}};$.ajax(c);this.setYelp=function(i){self.currentYelp(i);$("#yelp").show();$("#yelpTog").click(function(){$("#yelp").hide()});google.maps.event.trigger(this.markerId(),"click")}};var ViewModel=function(){var a=this;this.places=ko.observableArray([]);pDmodel.forEach(function(b){a.places.push(new PlaceData(b))});console.log("Places Model:");console.log(a.places());this.clickCount=ko.observable(0);this.currentYelp=ko.observable(this.places()[0]);$("#yelp").hide();initializeMap()};var nonce_generate=function(){var c=(Math.floor(Math.random()*32))+(Math.floor(Math.random()*32));var d="";var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(var b=0;b<c;b++){d+=a.charAt(Math.floor(Math.random()*a.length))}return d};var placeScrape=function(b){var a="https://maps.googleapis.com/maps/api/place/details/json?placeid="+places()[b].gPlace().place_id+"&key="+GOOGLEMAP_API;$.getJSON(a,function(c){places()[b].gData(c);console.log(c)}).error(function(c){console.log("Silly Rabbit tricks are for kids!")})};var infoWindow;var HandleInfoWindow=function(c,b){var a={lat:c.latitude,lng:c.longitude};infoWindow.setContent(b);infoWindow.setPosition(a);infoWindow.open(map)};var callback=function(c,a){if(a==google.maps.places.PlacesServiceStatus.OK){var d;for(var b in places()){if(c[0].name.toLowerCase()==places()[b].address().toLowerCase()){createMapMarker(c[0],b);places()[b].gPlace(c[0]);pinPoster2(c[0].place_id,b)}}}};var callback2=function(b,a,c){if(a==google.maps.places.PlacesServiceStatus.OK){places()[c].gData(b)}};var createMapMarker=function(f,e){var d=f.geometry.location.lat();var h=f.geometry.location.lng();var b=f.formatted_address;var c=window.mapBounds;var a=new google.maps.Marker({map:map,position:f.geometry.location,animation:google.maps.Animation.DROP,title:b});places()[e].markerId(a);var g=places()[e].contentString()+'<img src="'+places()[e].locImg()+'">';infoWindow=new google.maps.InfoWindow();google.maps.event.addListener(a,"click",function(i){console.log(a.position);console.log(places()[e].yelp().location.coordinate);console.log(i);HandleInfoWindow(places()[e].yelp().location.coordinate,g);if(a.getAnimation()!==null){a.setAnimation(null)}else{a.setAnimation(google.maps.Animation.BOUNCE)}self.currentYelp(places()[e]);$("#yelp").show();$("#yelpTog").click(function(){$("#yelp").hide();infoWindow.close(map,a);if(a.getAnimation()!==null){a.setAnimation(null)}})});google.maps.event.addListener(infoWindow,"closeclick",function(){$("#yelp").hide();if(a.getAnimation()!==null){a.setAnimation(null)}});c.extend(new google.maps.LatLng(d,h));map.fitBounds(c);map.setCenter(c.getCenter())};var pinPoster2=function(b,c){var a=new google.maps.places.PlacesService(map);var d={query:b};a.getDetails(d,callback2,c)};var pinPoster=function(){var a=new google.maps.places.PlacesService(map);for(var c in places()){var b={query:places()[c].location};a.textSearch(b,callback)}};var initializeMap=function(){var a={disableDefaultUI:false,noClear:true};map=new google.maps.Map(document.querySelector("#map"),a);window.mapBounds=new google.maps.LatLngBounds();pinPoster();pinPoster2()};ko.applyBindings(ViewModel());